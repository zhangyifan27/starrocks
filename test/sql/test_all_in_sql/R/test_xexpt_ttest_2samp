-- name: test_xexpt_ttest_2samp

drop database if exists xexpt_ttest_2samp_test_db;
-- result:
-- !result
create database xexpt_ttest_2samp_test_db;
-- result:
-- !result
use xexpt_ttest_2samp_test_db;
-- result:
-- !result
drop table if exists xexpt_ttest_2samp_test_tbl;
-- result:
-- !result
create table xexpt_ttest_2samp_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/xexpt_ttest_2samp_test_db/xexpt_ttest_2samp_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result

select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]793200 646026213 323166914
-- !result

select xexpt_ttest_2samp(X3, treatment, [numerator, denominator, X1, X2], 'X=x3/x4', 0.03, 0.004, 0.6) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]{"97%_CI": [-372.0395218038169, 61.44903661980163], "97%_relative_CI": [-0.4170514232542163, 0.06888356391717576], "MDE": 0.27133223440259185, "causal-function": "xexpt_ttest_2samp", "diff": -155.29524259200764, "diff_relative": -0.17408392966852027, "group0": {"denominator": 396774, "denominator_pre": 595507, "groupname": "0", "mean": 892.0710997718809, "numerator": 333186776, "numerator_pre": 2124493, "std_samp": 4.397270229398831e+4}, "group1": {"denominator": 396426, "denominator_pre": 595028, "groupname": "1", "mean": 736.7758571798732, "numerator": 3.128394373999962e+8, "numerator_pre": 2123883, "std_samp": 4.497416992664244e+4}, "p-value": 0.11998127516854318, "power": 0.030104915062061463, "recommend_samples": 1824084404, "schema": "{\n    causal-function(string),\n    group0(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      denominator_pre(double),\n      numerator_pre(double),\n      mean(double),\n      std_samp(double)\n    },\n    group1(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      denominator_pre(double),\n      numerator_pre(double),\n      mean(double),\n      std_samp(double)\n    },\n    97%_relative_CI(array),\n    97%_CI(array),\n    summary(string)\n  }", "summary": "\ngroupname   denominator numerator        denominator_pre numerator_pre mean        std_samp     \n0           396774      333186776        595507          2124493       892.071100  43972.702294 \n1           396426      312839437.399996 595028          2123883       736.775857  44974.169927 \n\ndiff_relative 97%_relative_CI         p-value     t-statistic diff        97%_CI                  power(MDE=0.004000) recommend_samples MDE(power=0.600000) \n-17.408393%   [-41.705142%,6.888356%] 0.119981    -1.554852   -155.295243 [-372.039522,61.449037] 0.030105            1824084404        0.271332            \n", "t-statistic": -1.5548521939483542}
-- !result

select xexpt_ttest_2samp(X3, treatment, [numerator, denominator, X1], 'X=x3', 0.3, 0.4, 0.12) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]{"70%_CI": [-1292.2946767901503, 1190.8983290423134], "70%_relative_CI": [-2.7620746030292818, 2.545356015555208], "MDE": -0.3547560787970569, "causal-function": "xexpt_ttest_2samp", "diff": -50.698173873918506, "diff_relative": -0.10835929373703682, "group0": {"denominator": 396773, "groupname": "0", "mean": 467.8710254143162, "numerator": 333186770, "std_samp": 5.562639833964821e+5}, "group1": {"denominator": 396426, "groupname": "1", "mean": 417.1728515403977, "numerator": 3.1283943739999557e+8, "std_samp": 5.09652793954558e+5}, "p-value": 0.9662429915783981, "power": 0.30587472280148137, "recommend_samples": 311818, "schema": "{\n    causal-function(string),\n    group0(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    group1(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    70%_relative_CI(array),\n    70%_CI(array),\n    summary(string)\n  }", "summary": "\ngroupname   denominator numerator        mean        std_samp      \n0           396773      333186770        467.871025  556263.983396 \n1           396426      312839437.399996 417.172852  509652.793955 \n\ndiff_relative 70%_relative_CI            p-value     t-statistic diff        70%_CI                     power(MDE=0.400000) recommend_samples MDE(power=0.120000) \n-10.835929%   [-276.207460%,254.535602%] 0.966243    -0.042321   -50.698174  [-1292.294677,1190.898329] 0.305875            311818            -0.354756           \n", "t-statistic": -0.04232076557646961}
-- !result

select xexpt_ttest_2samp(X1, treatment, [numerator, denominator], 'X=', 0.3, 0.4, 0.12) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]{"70%_CI": [-249.47259397103096, 148.28880539176555], "70%_relative_CI": [-0.29708259282824423, 0.17658862679843798], "MDE": -0.03166084619653447, "causal-function": "xexpt_ttest_2samp", "diff": -50.591894289632705, "diff_relative": -0.06024698301490314, "group0": {"denominator": 396773, "groupname": "0", "mean": 839.7415398729248, "numerator": 333186770, "std_samp": 7.977460784485748e+4}, "group1": {"denominator": 396426, "groupname": "1", "mean": 789.1496455832921, "numerator": 3.128394374000022e+8, "std_samp": 9.07666923797845e+4}, "p-value": 0.7920485949545708, "power": 0.7650584424362992, "recommend_samples": 2484, "schema": "{\n    causal-function(string),\n    group0(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    group1(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    70%_relative_CI(array),\n    70%_CI(array),\n    summary(string)\n  }", "summary": "\ngroupname   denominator numerator        mean        std_samp     \n0           396773      333186770        839.741540  79774.607845 \n1           396426      312839437.400002 789.149646  90766.692380 \n\ndiff_relative 70%_relative_CI          p-value     t-statistic diff        70%_CI                   power(MDE=0.400000) recommend_samples MDE(power=0.120000) \n-6.024698%    [-29.708259%,17.658863%] 0.792049    -0.263651   -50.591894  [-249.472594,148.288805] 0.765058            2484              -0.031661           \n", "t-statistic": -0.2636513389318103}
-- !result
