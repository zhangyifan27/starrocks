-- name: test_xexpt_ttest_2samp

drop database if exists xexpt_ttest_2samp_test_db;
-- result:
-- !result
create database xexpt_ttest_2samp_test_db;
-- result:
-- !result
use xexpt_ttest_2samp_test_db;
-- result:
-- !result
drop table if exists xexpt_ttest_2samp_test_tbl;
-- result:
-- !result
create table xexpt_ttest_2samp_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double,
    `uin` bigint
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/xexpt_ttest_2samp_test_db/xexpt_ttest_2samp_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result

select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]793200 646026213 323166914
-- !result

select xexpt_ttest_2samp(uin, treatment, [numerator, denominator, X1, X2], 'X=x3/x4', 0.03, 0.004, 0.6) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]{"97%_CI": [-201.47575267093885, 99.42493978710945], "97%_relative_CI": [-0.23986432025976237, 0.11836906070703938], "MDE": 0.20002730048543332, "causal-function": "xexpt_ttest_2samp", "diff": -51.0254064419147, "diff_relative": -0.0607476297763615, "group0": {"denominator": 396774, "denominator_pre": 595507, "groupname": "0", "mean": 839.9571576662572, "numerator": 333186776, "numerator_pre": 2124493, "std_samp": 3.540960545371641e+4}, "group1": {"denominator": 396426, "denominator_pre": 595028, "groupname": "1", "mean": 788.9317512243425, "numerator": 3.1283943740000004e+8, "numerator_pre": 2123883, "std_samp": 2.5547644386395445e+4}, "p-value": 0.46173681401903255, "power": 0.030193076021171654, "recommend_samples": 991335584, "schema": "{\n    causal-function(string),\n    group0(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      denominator_pre(double),\n      numerator_pre(double),\n      mean(double),\n      std_samp(double)\n    },\n    group1(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      denominator_pre(double),\n      numerator_pre(double),\n      mean(double),\n      std_samp(double)\n    },\n    97%_relative_CI(array),\n    97%_CI(array),\n    summary(string)\n  }", "summary": "\ngroupname   denominator numerator   denominator_pre numerator_pre mean        std_samp     \n0           396774      333186776   595507          2124493       839.957158  35409.605454 \n1           396426      312839437.4 595028          2123883       788.931751  25547.644386 \n\ndiff_relative 97%_relative_CI          p-value     t-statistic diff        97%_CI                  power(MDE=0.004000) recommend_samples MDE(power=0.600000) \n-6.074763%    [-23.986432%,11.836906%] 0.461737    -0.735990   -51.025406  [-201.475753,99.424940] 0.030193            991335584         0.200027            \n", "t-statistic": -0.73598994991026}
-- !result

select xexpt_ttest_2samp(uin, treatment, [numerator, denominator, X1], 'X=x3', 0.01, 0.005, 0.8) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]{"99%_CI": [-229.18046526361638, 127.59443035086576], "99%_relative_CI": [-1.7341466948822617, 0.9654726000482825], "MDE": 1.790839399979407, "causal-function": "xexpt_ttest_2samp", "diff": -50.79301745637531, "diff_relative": -0.3843370474169896, "group0": {"denominator": 396774, "groupname": "0", "mean": 132.15748468106176, "numerator": 333186776, "std_samp": 3.530643568365645e+4}, "group1": {"denominator": 396426, "groupname": "1", "mean": 81.36446722468645, "numerator": 3.1283943740000004e+8, "std_samp": 2.5609873511357444e+4}, "p-value": 0.46329705577039526, "power": 0.010003390945681017, "recommend_samples": 50855204265, "schema": "{\n    causal-function(string),\n    group0(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    group1(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    99%_relative_CI(array),\n    99%_CI(array),\n    summary(string)\n  }", "summary": "\ngroupname   denominator numerator   mean        std_samp     \n0           396774      333186776   132.157485  35306.435684 \n1           396426      312839437.4 81.364467   25609.873511 \n\ndiff_relative 99%_relative_CI           p-value     t-statistic diff        99%_CI                   power(MDE=0.005000) recommend_samples MDE(power=0.800000) \n-38.433705%   [-173.414669%,96.547260%] 0.463297    -0.733429   -50.793017  [-229.180465,127.594430] 0.010003            50855204265       1.790839            \n", "t-statistic": -0.7334286084760627}
-- !result

select xexpt_ttest_2samp(uin, treatment, [numerator, denominator], 'X=', 0.3, 0.4, 0.12) from xexpt_ttest_2samp_test_tbl;
-- result:
[LOOSE]{"70%_CI": [-122.44158550938171, 21.261999531787595], "70%_relative_CI": [-0.14580902109061922, 0.025319758195401762], "MDE": -0.011438486731471798, "causal-function": "xexpt_ttest_2samp", "diff": -50.58979298879706, "diff_relative": -0.06024463144760873, "group0": {"denominator": 396774, "groupname": "0", "mean": 839.7394385720838, "numerator": 333186776, "std_samp": 3.540211372840275e+4}, "group1": {"denominator": 396426, "groupname": "1", "mean": 789.1496455832868, "numerator": 3.1283943740000004e+8, "std_samp": 2.5554812251527408e+4}, "p-value": 0.4655503356731794, "power": 0.9999301614309049, "recommend_samples": 324, "schema": "{\n    causal-function(string),\n    group0(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    group1(object): {\n      groupname(string),\n      denominator(double),\n      numerator(double),\n      mean(double),\n      std_samp(double)\n    },\n    70%_relative_CI(array),\n    70%_CI(array),\n    summary(string)\n  }", "summary": "\ngroupname   denominator numerator   mean        std_samp     \n0           396774      333186776   839.739439  35402.113728 \n1           396426      312839437.4 789.149646  25554.812252 \n\ndiff_relative 70%_relative_CI         p-value     t-statistic diff        70%_CI                  power(MDE=0.400000) recommend_samples MDE(power=0.120000) \n-6.024463%    [-14.580902%,2.531976%] 0.465550    -0.729738   -50.589793  [-122.441586,21.262000] 0.999930            324               -0.011438           \n", "t-statistic": -0.7297380212728874}
-- !result
