-- name: test_ols

drop database if exists ols_test_db;
-- result:
-- !result
create database ols_test_db;
-- result:
-- !result
use ols_test_db;
-- result:
-- !result
drop table if exists ols_test_tbl;
-- result:
-- !result
create table ols_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double,
    `uin` bigint
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/ols_test_db/ols_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result

select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from ols_test_tbl;
-- result:
[LOOSE]793200 646026213 323166914
-- !result

select ols(Y, [X1, X2, X3, weight], false) from ols_test_tbl;
-- result:
[LOOSE]{"adjusted-r-squared": 0.016090185680994296, "causal-function": "ols", "coef": [{"estimate": -20.528704143120873, "p-value": 0.0011176436472632603, "stderr": 6.2988550731720725, "t-value": -3.259116760846939, "variable": "x1"}, {"estimate": 95.35302210172381, "p-value": 0.0018569693077866763, "stderr": 30.63833217763275, "t-value": 3.112213208894427, "variable": "x2"}, {"estimate": 3553.144390263948, "p-value": 0, "stderr": 31.19311515031759, "t-value": 113.90796889446844, "variable": "x3"}, {"estimate": -40.89482380976233, "p-value": 0.2816058434221001, "stderr": 37.98093824211593, "t-value": -1.0767196836758308, "variable": "x4"}], "df": 793195, "f-statistic": 3243.8579851122877, "f-value": 0, "formula": "y ~ x1 + x2 + x3 + x4 ", "num-variables": 4, "r-squared": 0.01609514741097281, "residual-stderr": 1.5528986180369651e+4, "schema": "{\n    causal-function(string),\n    formula(string),\n    coef(array): [{\n      variable(string),\n      estimate(double),\n      stderr(double),\n      t-value(double),\n      p-value(double)\n    }],\n    residual-stderr(double),\n    df(int),\n    r-squared(double),\n    adjusted-r-squared(double),\n    f-statistic(double),\n    num-variables(int),\n    f-value(double)\n  }", "summary": "\nCall:\n  lm( formula = y ~ x1 + x2 + x3 + x4 )\n\nCoefficients:\n.               Estimate    Std. Error  t value     Pr(>|t|)    \nx1              -20.528704  6.298855    -3.259117   0.001118    \nx2              95.353022   30.638332   3.112213    0.001857    \nx3              3553.144390 31.193115   113.907969  0.000000    \nx4              -40.894824  37.980938   -1.076720   0.281606    \n\nResidual standard error: 15528.986180 on 793195 degrees of freedom\nMultiple R-squared: 0.016095, Adjusted R-squared: 0.016090\nF-statistic: 3243.857985 on 4 and 793195 DF,  p-value: 0.000000\n"}
-- !result


select ols(Y, [X1, X2, X3, weight], true) from ols_test_tbl;
-- result:
[LOOSE]{"adjusted-r-squared": 0.01604828468992181, "causal-function": "ols", "coef": [{"estimate": 356.21689006487577, "p-value": 1.4474440342089345e-7, "stderr": 67.73252931541549, "t-value": 5.2591700570644875, "variable": "intercept"}, {"estimate": -45.842475164542975, "p-value": 7.34602926823922e-9, "stderr": 7.927275499203394, "t-value": -5.782879019298579, "variable": "x1"}, {"estimate": -29.268450111484526, "p-value": 0.4498511214263531, "stderr": 38.7321144754719, "t-value": -0.7556636271438142, "variable": "x2"}, {"estimate": 3548.677961504928, "p-value": 0, "stderr": 31.2041304291184, "t-value": 113.72462275678251, "variable": "x3"}, {"estimate": -52.068274724260306, "p-value": 0.1710654875591721, "stderr": 38.039652308094986, "t-value": -1.3687894490344743, "variable": "x4"}], "df": 793195, "f-statistic": 3235.275414558778, "f-value": 0, "formula": "y ~ x1 + x2 + x3 + x4 ", "num-variables": 4, "r-squared": 0.01605324663120167, "residual-stderr": 1.5528715438009602e+4, "schema": "{\n    causal-function(string),\n    formula(string),\n    coef(array): [{\n      variable(string),\n      estimate(double),\n      stderr(double),\n      t-value(double),\n      p-value(double)\n    }],\n    residual-stderr(double),\n    df(int),\n    r-squared(double),\n    adjusted-r-squared(double),\n    f-statistic(double),\n    num-variables(int),\n    f-value(double)\n  }", "summary": "\nCall:\n  lm( formula = y ~ x1 + x2 + x3 + x4 )\n\nCoefficients:\n.               Estimate    Std. Error  t value     Pr(>|t|)    \n(Intercept)     356.216890  67.732529   5.259170    0.000000    \nx1              -45.842475  7.927275    -5.782879   0.000000    \nx2              -29.268450  38.732114   -0.755664   0.449851    \nx3              3548.677962 31.204130   113.724623  0.000000    \nx4              -52.068275  38.039652   -1.368789   0.171065    \n\nResidual standard error: 15528.715438 on 793195 degrees of freedom\nMultiple R-squared: 0.016053, Adjusted R-squared: 0.016048\nF-statistic: 3235.275415 on 4 and 793195 DF,  p-value: 0.000000\n"}
-- !result

select ols_train(Y, [X1, X2, X3, weight], false) as params from ols_test_tbl;
-- result:
[LOOSE]{"coef": [-20.528704143256782, 95.35302209239728, 3553.1443902639503, -40.894823792298666], "name": "ols", "num_variables": 4, "use_bias": false}
-- !result

select ols_train(Y, [X1, X2, X3, weight], true) as params from ols_test_tbl;
-- result:
[LOOSE]{"coef": [-45.842475164561165, -29.268450120177476, 3548.67796150496, -52.06827470684013, 356.2168900632196], "name": "ols", "num_variables": 4, "use_bias": true}
-- !result

with model as (
    select ols_train(Y, [X1, X2, X3, weight], false) as params
    from ols_test_tbl
)
select round(eval_ml_method(model.params, [X1, X2, X3, weight]), 5) as Y_prime from ols_test_tbl, model order by Y_prime limit 10 offset 1000;
-- result:
-170.8507
-170.85039
-170.84204
-170.83302
-170.8327
-170.82533
-170.8169
-170.80384
-170.79763
-170.79657
-- !result

with model as (
    select ols_train(Y, [X1, X2, X3, weight], true) as params
    from ols_test_tbl
)
select round(eval_ml_method(model.params, [X1, X2, X3, weight]), 5) as Y_prime from ols_test_tbl, model order by Y_prime limit 10 offset 1000;
-- result:
-302.33981
-302.324
-302.31119
-302.30209
-302.29558
-302.25788
-302.2566
-302.24704
-302.24417
-302.19639
-- !result
