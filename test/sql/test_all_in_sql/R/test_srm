-- name: test_srm

drop database if exists srm_test_db;
-- result:
-- !result
create database srm_test_db;
-- result:
-- !result
use srm_test_db;
-- result:
-- !result
drop table if exists srm_test_tbl;
-- result:
-- !result
create table srm_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/srm_test_db/srm_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result
select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from srm_test_tbl;
-- result:
[LOOSE]793200 646026213 323166914
-- !result
select 'srm',  
  srm(numerator, treatment, [1, 1]),
  srm(denominator, treatment, [1, 2]),
  srm(denominator, treatment, [0, 0]),
  srm(denominator, treatment, [1])
from srm_test_tbl;
-- result:
[LOOSE]srm {"causal-function": "srm", "group0": {"chisquare": 6.408628311282817e+5, "f_obs": 333186776, "groupname": "0", "p-value": 0, "ratio": 1}, "group1": {"f_obs": 3.128394374000107e+8, "groupname": "1", "ratio": 1}, "schema": "{\n    causal-function,\n    group0: {\n      groupname,\n      f_obs,\n      ratio,\n      chisquare,\n      p-value\n    },\n    group1: {\n      groupname,\n      f_obs,\n      ratio\n    }\n  }", "summary": "\ngroupname   f_obs       ratio       chisquare   p-value     \n0           3.3319e+08  1.000000    6.4086e+05  0.000000    \n1           3.1284e+08  1.000000    \n"} {"causal-function": "srm", "group0": {"chisquare": 9.941117176248108e+4, "f_obs": 396774, "groupname": "0", "p-value": 0, "ratio": 1}, "group1": {"f_obs": 396426, "groupname": "1", "ratio": 2}, "schema": "{\n    causal-function,\n    group0: {\n      groupname,\n      f_obs,\n      ratio,\n      chisquare,\n      p-value\n    },\n    group1: {\n      groupname,\n      f_obs,\n      ratio\n    }\n  }", "summary": "\ngroupname   f_obs       ratio       chisquare   p-value     \n0           3.9677e+05  1.000000    99411.171762 0.000000    \n1           3.9643e+05  2.000000    \n"} {"causal-function": "srm", "error": "sum of ratio(0) must not equal to zero!", "schema": "{\n    causal-function,\n    error\n  }"} {"causal-function": "srm", "error": "the number of groups must equal to the number of ratios.", "schema": "{\n    causal-function,\n    error\n  }"}
-- !result
