-- name: test_wls

drop database if exists wls_test_db;
-- result:
-- !result
create database wls_test_db;
-- result:
-- !result
use wls_test_db;
-- result:
-- !result
drop table if exists wls_test_tbl;
-- result:
-- !result
create table wls_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/wls_test_db/wls_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result

select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from wls_test_tbl;
-- result:
[LOOSE]793200 646026213 323166914
-- !result

select wls(Y, [X1, X2, X3], weight, false) from wls_test_tbl;
-- result:
[LOOSE]{"adjusted-r-squared": 0.015302645192822428, "causal-function": "wls", "coef": [{"estimate": -21.786114573347632, "p-value": 6.439694640874123e-4, "stderr": 6.3843979554099946, "t-value": -3.412399215322499, "variable": "x1"}, {"estimate": 70.68812643683908, "p-value": 9.626060479195139e-4, "stderr": 21.412557837389386, "t-value": 3.301246258091012, "variable": "x2"}, {"estimate": 3342.5769365524466, "p-value": 0, "stderr": 30.183867106363564, "t-value": 110.74051329386293, "variable": "x3"}], "df": 793196, "f-statistic": 4109.891192149886, "f-value": 0, "formula": "y ~ x1 + x2 + x3 ", "num-variables": 3, "r-squared": 0.015306369468904941, "residual-stderr": 1.3814557004885706e+4, "schema": "{\n    causal-function,\n    formula,\n    coef: [{\n      variable,\n      estimate,\n      stderr,\n      t-value,\n      p-value\n    }],\n    residual-stderr,\n    df,\n    r-squared,\n    adjusted-r-squared,\n    f-statistic,\n    num-variables,\n    f-value\n  }", "summary": "\nCall:\n  lm( formula = y ~ x1 + x2 + x3 )\n\nCoefficients:\n.               Estimate    Std. Error  t value     Pr(>|t|)    \nx1              -21.786115  6.384398    -3.412399   0.000644    \nx2              70.688126   21.412558   3.301246    0.000963    \nx3              3342.576937 30.183867   110.740513  0.000000    \n\nResidual standard error: 13814.557005 on 793196 degrees of freedom\nMultiple R-squared: 0.015306, Adjusted R-squared: 0.015303\nF-statistic: 4109.891192 on 3 and 793196 DF,  p-value: 0.000000\n"}
-- !result


select wls(Y, [X1, X2, X3], weight, true) from wls_test_tbl;
-- result:
[LOOSE]{"adjusted-r-squared": 0.015202936851978599, "causal-function": "wls", "coef": [{"estimate": 429.262501205174, "p-value": 6.083973249889063e-9, "stderr": 73.82625081305542, "t-value": 5.814496828400004, "variable": "intercept"}, {"estimate": -47.1197069011381, "p-value": 1.0863576745369003e-9, "stderr": 7.729294514325499, "t-value": -6.09624938133827, "variable": "x1"}, {"estimate": -92.50530809360816, "p-value": 0.008782430240900628, "stderr": 35.3017677933229, "t-value": -2.6204157433471345, "variable": "x2"}, {"estimate": 3339.5906288473006, "p-value": 0, "stderr": 30.187593223328193, "t-value": 110.62791936213554, "variable": "x3"}], "df": 793196, "f-statistic": 4082.705344620183, "f-value": 0, "formula": "y ~ x1 + x2 + x3 ", "num-variables": 3, "r-squared": 0.015206661505173432, "residual-stderr": 1.3814262605537098e+4, "schema": "{\n    causal-function,\n    formula,\n    coef: [{\n      variable,\n      estimate,\n      stderr,\n      t-value,\n      p-value\n    }],\n    residual-stderr,\n    df,\n    r-squared,\n    adjusted-r-squared,\n    f-statistic,\n    num-variables,\n    f-value\n  }", "summary": "\nCall:\n  lm( formula = y ~ x1 + x2 + x3 )\n\nCoefficients:\n.               Estimate    Std. Error  t value     Pr(>|t|)    \n(Intercept)     429.262501  73.826251   5.814497    0.000000    \nx1              -47.119707  7.729295    -6.096249   0.000000    \nx2              -92.505308  35.301768   -2.620416   0.008782    \nx3              3339.590629 30.187593   110.627919  0.000000    \n\nResidual standard error: 13814.262606 on 793196 degrees of freedom\nMultiple R-squared: 0.015207, Adjusted R-squared: 0.015203\nF-statistic: 4082.705345 on 3 and 793196 DF,  p-value: 0.000000\n"}
-- !result

select wls_train(Y, [X1, X2, X3], weight, false) as params from wls_test_tbl;
-- result:
[LOOSE]{"coef": [-21.786114573347632, 70.68812643683908, 3342.5769365524466], "name": "ols", "num_variables": 3, "use_bias": false}
-- !result

select wls_train(Y, [X1, X2, X3], weight, true) as params from wls_test_tbl;
-- result:
[LOOSE]{"coef": [-47.1197069011381, -92.50530809360816, 3339.5906288473006, 429.262501205174], "name": "ols", "num_variables": 3, "use_bias": true}
-- !result

with model as (
    select wls_train(Y, [X1, X2, X3], weight, false) as params
    from wls_test_tbl
)
select round(avg(eval_ml_method(model.params, [X1, X2, X3])), 5) from wls_test_tbl, model;
-- result:
351.9874
-- !result

with model as (
    select wls_train(Y, [X1, X2, X3], weight, true) as params
    from wls_test_tbl
)
select round(avg(eval_ml_method(model.params, [X1, X2, X3])), 5) from wls_test_tbl, model;
-- result:
400.29798
-- !result
