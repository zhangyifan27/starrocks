-- name: test_ttest_2samp

drop database if exists ttest_2samp_test_db;
-- result:
-- !result
create database ttest_2samp_test_db;
-- result:
-- !result
use ttest_2samp_test_db;
-- result:
-- !result
drop table if exists ttest_2samp_test_tbl;
-- result:
-- !result
create table ttest_2samp_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/ttest_2samp_test_db/ttest_2samp_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result

select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from ttest_2samp_test_tbl;
-- result:
[REGEX]793200\s646026213\s323166914
-- !result


select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -50.589792988770114, "lower": "-inf", "mean0": 839.7394385720838, "mean1": 789.1496455833137, "p-value": 0.23588722544003127, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 70.3031563236187, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n839.739439  789.149646  -50.589793  70.303156   -0.719595   0.235887    -inf        65.048744   \n", "t-statistic": -0.7195949034762501, "upper": 65.04874373179427}
-- !result

select ttest_2samp('x1/x2', 'two-sided', treatment, [numerator, denominator]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -50.589792988770114, "lower": -188.38165764303568, "mean0": 839.7394385720838, "mean1": 789.1496455833137, "p-value": 0.47177445088006253, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 70.3031563236187, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n839.739439  789.149646  -50.589793  70.303156   -0.719595   0.471774    -188.381658 87.202072   \n", "t-statistic": -0.7195949034762501, "upper": 87.20207166549545}
-- !result

select ttest_2samp('x1/x2', 'greater', treatment, [numerator, denominator]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -50.589792988770114, "lower": -166.2283297093345, "mean0": 839.7394385720838, "mean1": 789.1496455833137, "p-value": 0.7641127745599687, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 70.3031563236187, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n839.739439  789.149646  -50.589793  70.303156   -0.719595   0.764113    -166.228330 inf         \n", "t-statistic": -0.7195949034762501, "upper": "inf"}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=x3/x4+x5') from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -61.58715848975123, "lower": "-inf", "mean0": 845.2357068043058, "mean1": 783.6485483145545, "p-value": 0.1885851059189124, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 69.7379745028398, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.235707  783.648548  -61.587158  69.737975   -0.883122   0.188585    -inf        53.121736   \n", "t-statistic": -0.8831222720304751, "upper": 53.121735777278275}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=x3/x4+x5', 0.95) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -61.58715848975123, "lower": "-inf", "mean0": 845.2357068043058, "mean1": 783.6485483145545, "p-value": 0.1885851059189124, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 69.7379745028398, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.235707  783.648548  -61.587158  69.737975   -0.883122   0.188585    -inf        -176.296053 \n", "t-statistic": -0.8831222720304751, "upper": -176.29605275678074}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=x3/x4+x5', 0.95, [X3_string]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -60.53403290258052, "lower": "-inf", "mean0": 845.096016789256, "mean1": 784.5619838866755, "p-value": 0.1930289610070574, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 69.83714616142277, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.096017  784.561984  -60.534033  69.837146   -0.866788   0.193029    -inf        -175.406050 \n", "t-statistic": -0.8667884675966159, "upper": -175.4060502224342}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=', 0.95, [X3_string]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -61.60459551322742, "lower": "-inf", "mean0": 845.6310310547418, "mean1": 784.0264355415144, "p-value": 0.18890113856422494, "schema": "{\n    causal-function,\n    mean0,\n    mean1,\n    estimate,\n    stderr,\n    t-statistic,\n    p-value,\n    lower,\n    upper,\n    summary\n  }", "stderr": 69.85021010334904, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.631031  784.026436  -61.604596  69.850210   -0.881953   0.188901    -inf        -176.498101 \n", "t-statistic": -0.8819529021040657, "upper": -176.49810113043725}
-- !result
