-- name: test_ttest_2samp

drop database if exists ttest_2samp_test_db;
-- result:
-- !result
create database ttest_2samp_test_db;
-- result:
-- !result
use ttest_2samp_test_db;
-- result:
-- !result
drop table if exists ttest_2samp_test_tbl;
-- result:
-- !result
create table ttest_2samp_test_tbl
(
    `treatment` boolean,
    `numerator` double,
    `denominator` boolean,
    `numerator_pre` bigint,
    `denominator_pre` boolean,
    `Y` double,
    `X1` int,
    `X2` int,
    `X3` int,
    `X3_string` string,
    `X7_needcut` bigint,
    `X8_needcut` bigint,
    `weight` double,
    `distance` double
)
properties (
    "replication_num"="1"
);
-- result:
-- !result
shell: curl --location-trusted -u root: -T ${root_path}/lib/../common/data/stream_load/all_in_sql_test.csv -XPUT -H column_separator:, ${url}/api/ttest_2samp_test_db/ttest_2samp_test_tbl/_stream_load
-- result:
-- !result
sync;
-- result:
-- !result

select count(*), floor(sum(`numerator`)), floor(sum(`Y`)) from ttest_2samp_test_tbl;
-- result:
[REGEX]793200\s646026213\s323166914
-- !result


select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -50.59189428960849, "lower": "-inf", "mean0": 839.7415398729248, "mean1": 789.1496455833163, "p-value": 0.23587835588493186, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 70.30326242653112, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n839.741540  789.149646  -50.591894  70.303262   -0.719624   0.235878    -inf        65.046817   \n", "t-statistic": -0.7196237065453177, "upper": 65.04681695509034}
-- !result

select ttest_2samp('x1/x2', 'two-sided', treatment, [numerator, denominator]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -50.59189428960849, "lower": -188.38396690234347, "mean0": 839.7415398729248, "mean1": 789.1496455833163, "p-value": 0.4717567117698638, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 70.30326242653112, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n839.741540  789.149646  -50.591894  70.303262   -0.719624   0.471757    -188.383967 87.200178   \n", "t-statistic": -0.7196237065453177, "upper": 87.2001783231265}
-- !result

select ttest_2samp('x1/x2', 'greater', treatment, [numerator, denominator]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -50.59189428960849, "lower": -166.2306055343073, "mean0": 839.7415398729248, "mean1": 789.1496455833163, "p-value": 0.7641216441150681, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 70.30326242653112, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n839.741540  789.149646  -50.591894  70.303262   -0.719624   0.764122    -166.230606 inf         \n", "t-statistic": -0.7196237065453177, "upper": "inf"}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=x3/x4+x5') from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -61.58739506918562, "lower": "-inf", "mean0": 845.2368831067347, "mean1": 783.6494880375491, "p-value": 0.18858455026566764, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 69.7380799509184, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.236883  783.649488  -61.587395  69.738080   -0.883124   0.188585    -inf        53.121673   \n", "t-statistic": -0.883124329097256, "upper": 53.1216726448699}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=x3/x4+x5', 0.95) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -61.58739506918562, "lower": "-inf", "mean0": 845.2368831067347, "mean1": 783.6494880375491, "p-value": 0.18858455026566764, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 69.7380799509184, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.236883  783.649488  -61.587395  69.738080   -0.883124   0.188585    -inf        -176.296463 \n", "t-statistic": -0.883124329097256, "upper": -176.29646278324114}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=x3/x4+x5', 0.95, [X3_string]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -60.534209310401934, "lower": "-inf", "mean0": 845.0971200608027, "mean1": 784.5629107504008, "p-value": 0.19302856839615945, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 69.83723423560255, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.097120  784.562911  -60.534209  69.837234   -0.866790   0.193029    -inf        -175.406371 \n", "t-statistic": -0.8667899004445683, "upper": -175.40637149972804}
-- !result

select ttest_2samp('x1/x2', 'less', treatment, [numerator, denominator, X1, X2, X3], 'X=', 0.95, [X3_string]) from ttest_2samp_test_tbl;
-- result:
[LOOSE]{"causal-function": "ttest_2samp", "estimate": -61.604776356681214, "lower": "-inf", "mean0": 845.6321365414179, "mean1": 784.0273601847367, "p-value": 0.18890073925281176, "schema": "{\n    causal-function(string),\n    mean0(double),\n    mean1(double),\n    estimate(double),\n    stderr(double),\n    t-statistic(double),\n    p-value(double),\n    lower(double),\n    upper(double),\n    summary(string)\n  }", "stderr": 69.85029819398873, "summary": "\nmean0       mean1       estimate    stderr      t-statistic p-value     lower       upper       \n845.632137  784.027360  -61.604776  69.850298   -0.881954   0.188901    -inf        -176.498427 \n", "t-statistic": -0.8819543788573672, "upper": -176.49842687043764}
-- !result
